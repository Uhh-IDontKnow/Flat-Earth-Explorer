name: Deploy Flat Earth Explorer to Azure Static Web Apps

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened, closed ]
    branches: [ main ]

jobs:
  build_and_deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ── SECURITY: Inject API key and build to ./dist ──
      - name: Build dist folder with injected API key
        env:
          MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        run: |
          node -e "
            const fs   = require('fs');
            const path = require('path');

            const apiKey = process.env.MAPS_API_KEY;
            if (!apiKey) {
              console.error('ERROR: GOOGLE_MAPS_API_KEY secret is empty or not set.');
              process.exit(1);
            }

            // Copy everything from ./src into ./dist
            function copyDir(src, dest) {
              fs.mkdirSync(dest, { recursive: true });
              for (const entry of fs.readdirSync(src, { withFileTypes: true })) {
                const s = path.join(src, entry.name);
                const d = path.join(dest, entry.name);
                entry.isDirectory() ? copyDir(s, d) : fs.copyFileSync(s, d);
              }
            }
            copyDir('./src', './dist');

            // Replace placeholder in dist/index.html
            const htmlPath = './dist/index.html';
            let html = fs.readFileSync(htmlPath, 'utf8');
            const count = (html.match(/YOUR_GOOGLE_MAPS_API_KEY/g) || []).length;
            console.log('Placeholder occurrences found: ' + count);
            if (count === 0) {
              console.error('ERROR: Placeholder YOUR_GOOGLE_MAPS_API_KEY not found in index.html');
              process.exit(1);
            }
            html = html.replaceAll('YOUR_GOOGLE_MAPS_API_KEY', apiKey);
            fs.writeFileSync(htmlPath, html, 'utf8');
            console.log('Replaced ' + count + ' occurrence(s).');
          "

      # ── CRITICAL: Print the exact key line so we can verify in logs ──
      - name: Show injected key line (first+last 6 chars visible)
        run: |
          echo "=== MAPS_API_KEY line in dist/index.html ==="
          grep "MAPS_API_KEY" ./dist/index.html
          echo ""
          echo "=== Files in ./dist ==="
          ls -la ./dist/
          echo ""
          echo "=== Checking for any remaining placeholders ==="
          grep -c "YOUR_GOOGLE_MAPS_API_KEY" ./dist/index.html && echo "ERROR: placeholder still present" && exit 1 || echo "OK: no placeholders remaining"

      # ── DEPLOY from ./dist (no swa-cli.config.json interference) ──
      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli

      - name: Deploy from dist
        run: |
          swa deploy ./dist \
            --deployment-token ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }} \
            --env production \
            --verbose

  close_pull_request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli

      - name: Close staging environment
        run: swa deploy --deployment-token ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }} --env close
